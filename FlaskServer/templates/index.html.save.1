<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="author" content="Chris Haworth">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="/Styles/styles.css">

	<title>RWC GUI - Home</title>
</head>

<body>
<section name="centerContent">
<div name="topBar">
	<h1>Raspi Watering Co. Web GUI</h1>
	<nav>
		<a href="index.html">Home</a>
		<a href="initialize.html">Initialize</a>
		<a href="water-log.html">Water Log</a> 
	</nav>
</div>

<div name="left">
	<h3>Weather Report</h3>
	
</div>

<div name="right">
	<p>Last rained <b><var id="lastRained"></var></b> days ago</p>
	<h3>Sectors</h3>
	<p id="sectorTable">
		<table>
		<tr><th>ID</th><th>Pin</th><th>Rain Inc.</th><th>Override</th>
		{% for sector in data['sectData'].sector %}
		<tr>sector["id"]</tr><tr>sector["pin"]</tr><tr>sector["rain-inc"]</tr><tr><button type="submit">Water Now</button></tr>
		{% endfor %}
		</table>
	</p>
	<form method="POST">
	<button name="waterAll" type="submit">Water All</button>
	</form>
</div>
</section>
</body>

<script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script>
function WaterOn(){
	$.ajax({
		url: "/ScriptsPy/pumpCtrl.py",
		context: document.body
	}).done(function(){
		alert("Python script executed");;
	});
}
</script>
<script>
function GetWeatherReport(){
	console.log("begin getting weather report");
	var request = new XMLHttpRequest();
	request.open("GET", "ScriptsPy/TextFiles/forecast.txt", true);
	request.send(null);
	console.log(request);
	request.onreadystatechange = function(){
		if (request.readyState == 4 && request.status == 200){
			var forecast = request.responseText.split("\n");
			var upcoming = [];
			var counter = 0;
			console.log(forecast);
			
			for (var i = 0; i < forecast.length; i++){
				if (counter == 8){
					break;
				}
				else{
					upcoming.push(forecast[i]);
					counter++;
				}
			}
			console.log(upcoming);
			
			var time = [];
			var status = [];
			for (var i = 0; i < upcoming.length; i++){
				time.push(upcoming[i].substr(upcoming[i].indexOf("reference_time=") + 15, 19));
				status.push(upcoming[i].substr(upcoming[i].indexOf("status=") + 7, 6)); 
			}
			for (var i = 0; i < status.length; i++){
					status[i] = status[i].replace(", ", "");
			}
			console.log(time);
			console.log(status);
		
			//Table headers
			var col = [];
			col.push("Date");
			col.push("Time (GMT)");
			col.push("Status");

			var table = document.createElement("table");
			var tr = table.insertRow(-1);

			for (var i = 0; i < col.length; i++){
				var th = document.createElement("th");
				th.innerHTML = col[i];
				tr.appendChild(th);
			}
			for (var i = 0; i < upcoming.length; i++){
				tr = table.insertRow(-1);

				for (var j = 0; j< col.length; j++){
					var tabCell = tr.insertCell(-1)
					if (j == 0){
						tabCell.innerHTML = time[i].substr(0, 10);
					}
					else if (j == 1){
						tabCell.innerHTML = time[i].substr(time[i].indexOf(" ") + 1);
					}
					else if (j == 2){
						tabCell.innerHTML = status[i];
					}
				}
			}

			var divContainer = document.getElementById("weather");
			divContainer.innerHTML = "";
			divContainer.appendChild(table);
			console.log(table);
		}
	}
}

function MakeSectorTable(){
	console.log("begin making sector table");
	var request = new XMLHttpRequest();
	request.open("GET", "/ScriptsPy/JSON/watering-sectors.json", true); 
	request.send(null);
	console.log(request);
	request.onreadystatechange = function(){
		if (request.readyState == 4 && request.status == 200){
			var sectData = JSON.parse(request.responseText);
			console.log(sectData);
			
			//Last rain
			document.getElementById("lastRained").value = sectData["last-rained"];

			//Table headers	
			var col = [];
			for (var i = 0; i < sectData.sector.length; i++){
				for (var key in sectData.sector[i]){
					if (col.indexOf(key) === -1){
						col.push(key);
					}
				}
			}
			col.push("Override");
			console.log(col);

			var table = document.createElement("table");
			var tr = table.insertRow(-1);

			for (var i = 0; i < col.length; i++){
				var th = document.createElement("th");
				if (col[i] == "id"){
					th.innerHTML = "ID";
				}
				else if (col[i] == "pin"){
					th.innerHTML = "Pin";
				}
				else if (col[i] == "rain-inc"){
					th.innerHTML = "Rain Inc.";
				}
				else{
					th.innerHTML = col[i];
				}
				tr.appendChild(th);
			}
			for (var i = 0; i < sectData.sector.length; i++){
				tr = table.insertRow(-1);

				for (var j = 0; j < col.length; j++){
					var tabCell = tr.insertCell(-1);
					if (col[j] == "Override"){
						var button = document.createElement("BUTTON");
						button.innerHTML = "Water Now";
						tabCell.appendChild(button);
					}
					else{
						tabCell.innerHTML = sectData.sector[i][col[j]];
					}
				}
			}

			var divContainer = document.getElementById("sectorTable");
			divContainer.innerHTML = "";
			divContainer.appendChild(table);
			console.log(table);
		}
	}
}

function RunScript(){
	GetWeatherReport();
	MakeSectorTable();
}
</script>
</html>
